{% extends 'base.html' %}
{% load static %}

{% block title %}G√©n√©ration d'√âtats Professionnels{% endblock %}

{% block extra_css %}
<style>
    .filter-section {
        background: linear-gradient(135deg, var(--dgrad-bleu) 0%, #2a4a6f 100%);
        color: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .filter-section .form-label {
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }
    
    .filter-section .form-control,
    .filter-section .form-select {
        background-color: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .results-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 20px;
    }
    
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .table thead th {
        position: sticky;
        top: 0;
        background-color: var(--dgrad-bleu);
        color: white;
        z-index: 10;
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .stats-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid var(--dgrad-dore);
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
    }
    
    .btn-generate {
        background: linear-gradient(135deg, var(--dgrad-dore) 0%, #f4d03f 100%);
        color: #000;
        border: none;
        padding: 12px 30px;
        font-weight: bold;
        border-radius: 6px;
        transition: all 0.3s;
    }
    
    .btn-generate:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(212, 175, 55, 0.3);
        color: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="bi bi-file-earmark-pdf"></i> G√©n√©ration d'√âtat
            </h2>
        </div>
    </div>

    <!-- Section des Filtres -->
    <div class="row">
        <div class="col-12">
            <div class="filter-section">
                <h5 class="mb-4">
                    <i class="bi bi-funnel"></i> Crit√®res de Consultation
                </h5>
                
                <form id="filterForm" method="post">
                    {% csrf_token %}
                    <div class="row">
                        <!-- Type d'√©tat -->
                        <div class="col-md-4 mb-3">
                            {{ form.type_etat.label_tag }}
                            {{ form.type_etat }}
                            {% if form.type_etat.errors %}
                                <div class="text-danger">
                                    {% for error in form.type_etat.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Type de rapport -->
                        <div class="col-md-4 mb-3">
                            {{ form.type_rapport.label_tag }}
                            {{ form.type_rapport }}
                            {% if form.type_rapport.errors %}
                                <div class="text-danger">
                                    {% for error in form.type_rapport.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Crit√®re de regroupement -->
                        <div class="col-md-4 mb-3" id="container_critere_groupement" style="display: none;">
                            {{ form.critere_groupement.label_tag }}
                            {{ form.critere_groupement }}
                            {% if form.critere_groupement.errors %}
                                <div class="text-danger">
                                    {% for error in form.critere_groupement.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Filtres pour les d√©penses -->
                    <div id="filtres_depenses" style="display: none;">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                {{ form.annee_depenses.label_tag }}
                                {{ form.annee_depenses }}
                                {% if form.annee_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.annee_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.mois_depenses.label_tag }}
                                {{ form.mois_depenses }}
                                {% if form.mois_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.mois_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.natures_depenses.label_tag }}
                                {{ form.natures_depenses }}
                                {% if form.natures_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.natures_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.services_depenses.label_tag }}
                                {{ form.services_depenses }}
                                {% if form.services_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.services_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                {{ form.banques_depenses.label_tag }}
                                {{ form.banques_depenses }}
                                {% if form.banques_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.banques_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.montant_min_depenses.label_tag }}
                                {{ form.montant_min_depenses }}
                                {% if form.montant_min_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.montant_min_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.montant_max_depenses.label_tag }}
                                {{ form.montant_max_depenses }}
                                {% if form.montant_max_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.montant_max_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.observation_depenses.label_tag }}
                                {{ form.observation_depenses }}
                                {% if form.observation_depenses.errors %}
                                    <div class="text-danger">
                                        {% for error in form.observation_depenses.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtres pour les recettes -->
                    <div id="filtres_recettes" style="display: none;">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                {{ form.annee_recettes.label_tag }}
                                {{ form.annee_recettes }}
                                {% if form.annee_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.annee_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.mois_recettes.label_tag }}
                                {{ form.mois_recettes }}
                                {% if form.mois_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.mois_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.banques_recettes.label_tag }}
                                {{ form.banques_recettes }}
                                {% if form.banques_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.banques_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.libelle_recettes.label_tag }}
                                {{ form.libelle_recettes }}
                                {% if form.libelle_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.libelle_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                {{ form.montant_min_recettes.label_tag }}
                                {{ form.montant_min_recettes }}
                                {% if form.montant_min_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.montant_min_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.montant_max_recettes.label_tag }}
                                {{ form.montant_max_recettes }}
                                {% if form.montant_max_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.montant_max_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.montant_usd_min_recettes.label_tag }}
                                {{ form.montant_usd_min_recettes }}
                                {% if form.montant_usd_min_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.montant_usd_min_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                {{ form.montant_usd_max_recettes.label_tag }}
                                {{ form.montant_usd_max_recettes }}
                                {% if form.montant_usd_max_recettes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.montant_usd_max_recettes.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <button type="button" class="btn btn-light me-2" onclick="applyFilters()">
                                <i class="bi bi-search"></i> Appliquer les filtres
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="resetFilters()">
                                <i class="bi bi-arrow-clockwise"></i> R√©initialiser
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Section des R√©sultats -->
    <div class="row">
        <div class="col-12">
            <div class="results-section">
                <!-- Statistiques -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h6>Total Enregistrements</h6>
                            <h3 id="totalRecords">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h6>Total USD</h6>
                            <h3 id="totalUSD">0.00</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h6>Total CDF</h6>
                            <h3 id="totalCDF">0.00</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h6>Derni√®re Mise √† Jour</h6>
                            <h6 id="lastUpdate">-</h6>
                        </div>
                    </div>
                </div>
                
                <!-- Tableau des r√©sultats -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="resultsTable">
                        <thead>
                            <tr id="tableHeaders">
                                <th colspan="100%" class="text-center text-muted">
                                    <i class="bi bi-info-circle"></i> 
                                    S√©lectionnez un type d'√©tat et appliquez les filtres pour voir les r√©sultats
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="100%" class="text-center text-muted">
                                    Aucune donn√©e √† afficher
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="row mt-3" id="paginationContainer" style="display: none;">
                    <div class="col-12">
                        <nav aria-label="Pagination des r√©sultats">
                            <ul class="pagination justify-content-center">
                                <li class="page-item" id="prevPage">
                                    <button type="button" class="page-link" onclick="changePage('prev')">
                                        <i class="bi bi-chevron-left"></i> Pr√©c√©dent
                                    </button>
                                </li>
                                <li class="page-item active">
                                    <span class="page-link" id="currentPage">1</span>
                                </li>
                                <li class="page-item" id="nextPage">
                                    <button type="button" class="page-link" onclick="changePage('next')">
                                        Suivant <i class="bi bi-chevron-right"></i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                Page <span id="currentPageInfo">1</span> sur <span id="totalPages">1</span> 
                                (<span id="totalCountInfo">0</span> r√©sultats au total)
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-generate me-2" onclick="generateState('PDF')" id="generatePDF" disabled>
                            <i class="bi bi-file-pdf"></i> G√©n√©rer PDF
                        </button>
                        <button type="button" class="btn btn-success me-2" onclick="generateState('EXCEL')" id="generateExcel" disabled>
                            <i class="bi bi-file-excel"></i> G√©n√©rer Excel
                        </button>
                        <button type="button" class="btn btn-primary" onclick="generateState('LES_DEUX')" id="generateBoth" disabled>
                            <i class="bi bi-files"></i> G√©n√©rer les deux
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="text-center text-white">
        <div class="spinner-border mb-3" style="width: 3rem; height: 3rem;"></div>
        <h4>G√©n√©ration en cours...</h4>
        <p>Veuillez patienter</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Configuration des en-t√™tes de tableau par type d'√©tat
const tableHeaders = {
    'DEPENSE_FEUILLE': ['Date', 'Libell√© D√©penses', 'Nature √âconomique', 'Service B√©n√©ficiaire', 'Banque', 'Montant CDF', 'Montant USD', 'Observation'],
    'RECETTE_FEUILLE': ['Date', 'Libell√© Recette', 'Banque', 'Montant CDF', 'Montant USD']
};

let currentData = [];
let currentPage = 1;
let totalPages = 1;
let totalCount = 0;

// Gestion du changement de type d'√©tat
document.getElementById('id_type_etat').addEventListener('change', function() {
    const typeEtat = this.value;
    console.log('Changement type √©tat:', typeEtat); // Debug
    console.log('Valeur dans change event:', this.value); // Debug
    console.log('Selected index:', this.selectedIndex); // Debug
    console.log('Selected option:', this.options[this.selectedIndex]); // Debug
    
    const filtresDepenses = document.getElementById('filtres_depenses');
    const filtresRecettes = document.getElementById('filtres_recettes');
    
    // Masquer tous les filtres
    filtresDepenses.style.display = 'none';
    filtresRecettes.style.display = 'none';
    
    // Afficher les filtres appropri√©s
    if (typeEtat === 'DEPENSE_FEUILLE') {
        filtresDepenses.style.display = 'block';
        console.log('Affichage filtres d√©penses'); // Debug
    } else if (typeEtat === 'RECETTE_FEUILLE') {
        filtresRecettes.style.display = 'block';
        console.log('Affichage filtres recettes'); // Debug
    }
    
    // R√©initialiser le tableau
    resetFilters();
});

// Gestion du changement de type de rapport
document.getElementById('id_type_rapport').addEventListener('change', function() {
    const typeRapport = this.value;
    console.log('Changement type rapport:', typeRapport);
    
    const containerCritere = document.getElementById('container_critere_groupement');
    
    // Afficher/masquer le crit√®re de regroupement
    if (typeRapport === 'GROUPE') {
        containerCritere.style.display = 'block';
    } else {
        containerCritere.style.display = 'none';
    }
    
    // R√©initialiser les donn√©es
    resetFilters();
});

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

// Appliquer les filtres
function applyFilters(page = 1) {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    
    // Supprimer les valeurs existantes de page pour √©viter les doublons
    formData.delete('page');
    
    // Ajouter le num√©ro de page
    formData.append('page', page.toString());
    
    // Debug: afficher le CSRF token et les donn√©es
    console.log('CSRF Token:', form.querySelector('input[name="csrfmiddlewaretoken"]').value);
    console.log('FormData entries:', Array.from(formData.entries()));
    console.log('Page demand√©e:', page);
    
    const typeEtat = formData.get('type_etat');
    console.log('Type √©tat s√©lectionn√©:', typeEtat); // Debug
    
    if (!typeEtat || typeEtat === '' || typeEtat.trim() === '') {
        alert('Veuillez s√©lectionner un type d\'√©tat');
        return;
    }
    
    // Utiliser notre endpoint personnalis√© pour les feuilles
    fetch('/tableau-bord-feuilles/preview-etats/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('R√©ponse:', data); // Debug
        if (data.success) {
            updateTable(data);
            updateStats(data);
            updatePagination(data);
            enableGenerateButtons();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        console.error('Error details:', error.message);
        alert('Erreur lors de la r√©cup√©ration des donn√©es: ' + error.message);
    });
}

// Mettre √† jour le tableau
function updateTable(data) {
    console.log('üìä Donn√©es re√ßues dans updateTable:', data);
    console.log('üìä Nombre de lignes re√ßues:', data.lignes ? data.lignes.length : 0);
    
    const typeEtat = document.getElementById('id_type_etat').value;
    const headers = tableHeaders[typeEtat] || [];
    
    // Mettre √† jour les en-t√™tes
    const headerRow = document.getElementById('tableHeaders');
    headerRow.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
    
    // Mettre √† jour le corps
    const tbody = document.getElementById('tableBody');
    if (data.lignes && data.lignes.length > 0) {
        console.log('üìä G√©n√©ration du tableau avec', data.lignes.length, 'lignes');
        tbody.innerHTML = data.lignes.map(item => formatTableRow(item, typeEtat)).join('');
        console.log('üìä Tableau mis √† jour, nombre de lignes dans le DOM:', tbody.children.length);
    } else {
        console.log('üìä Aucune donn√©e √† afficher');
        tbody.innerHTML = `<tr><td colspan="${headers.length}" class="text-center text-muted">Aucune donn√©e trouv√©e</td></tr>`;
    }
    
    currentData = data;
}

// Formater une ligne de tableau selon le type
function formatTableRow(item, typeEtat) {
    switch(typeEtat) {
        case 'DEPENSE_FEUILLE':
            return `<tr>
                <td>${item.date || ''}</td>
                <td>${item.libelle_depenses || ''}</td>
                <td>${item.nature_economique || ''}</td>
                <td>${item.service_beneficiaire || ''}</td>
                <td>${item.banque || ''}</td>
                <td class="text-end">${formatNumber(item.montant_fc)}</td>
                <td class="text-end">${formatNumber(item.montant_usd)}</td>
                <td>${item.observation || ''}</td>
            </tr>`;
        case 'RECETTE_FEUILLE':
            return `<tr>
                <td>${item.date || ''}</td>
                <td>${item.libelle_recette || ''}</td>
                <td>${item.banque || ''}</td>
                <td class="text-end">${formatNumber(item.montant_fc)}</td>
                <td class="text-end">${formatNumber(item.montant_usd)}</td>
            </tr>`;
        case 'TOUS_FEUILLES':
            const typeClass = item.type === 'd√©pense' ? 'text-danger' : 'text-success';
            return `<tr>
                <td>${item.date || ''}</td>
                <td><span class="badge ${item.type === 'd√©pense' ? 'bg-danger' : 'bg-success'}">${item.type || ''}</span></td>
                <td>${item.libelle || ''}</td>
                <td>${item.nature || ''}</td>
                <td>${item.service || ''}</td>
                <td>${item.banque || ''}</td>
                <td class="text-end ${typeClass}">${formatNumber(item.montant_cdf)}</td>
                <td class="text-end ${typeClass}">${formatNumber(item.montant_usd)}</td>
                <td>${item.observation || ''}</td>
            </tr>`;
        default:
            return `<tr><td colspan="100%">Format non impl√©ment√©</td></tr>`;
    }
}

// Mettre √† jour les statistiques
function updateStats(data) {
    document.getElementById('totalRecords').textContent = data.total_count || 0;
    document.getElementById('totalUSD').textContent = formatNumber(data.total_usd || 0);
    document.getElementById('totalCDF').textContent = formatNumber(data.total_cdf || 0);
    document.getElementById('lastUpdate').textContent = new Date().toLocaleString('fr-FR');
}

// Mettre √† jour la pagination
function updatePagination(data) {
    currentPage = data.page || 1;
    totalCount = data.total_count || 0;
    const pageSize = data.page_size || 50;
    totalPages = Math.ceil(totalCount / pageSize);
    
    // Mettre √† jour les √©l√©ments de pagination
    const currentPageElement = document.getElementById('currentPage');
    const currentPageInfoElement = document.getElementById('currentPageInfo');
    const totalPagesElement = document.getElementById('totalPages');
    const totalCountInfoElement = document.getElementById('totalCountInfo');
    
    if (currentPageElement) currentPageElement.textContent = currentPage;
    if (currentPageInfoElement) currentPageInfoElement.textContent = currentPage;
    if (totalPagesElement) totalPagesElement.textContent = totalPages;
    if (totalCountInfoElement) totalCountInfoElement.textContent = totalCount;
    
    // G√©rer l'√©tat des boutons
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (prevBtn) {
        if (currentPage <= 1) {
            prevBtn.classList.add('disabled');
            prevBtn.querySelector('button').style.pointerEvents = 'none';
        } else {
            prevBtn.classList.remove('disabled');
            prevBtn.querySelector('button').style.pointerEvents = 'auto';
        }
    }
    
    if (nextBtn) {
        if (currentPage >= totalPages) {
            nextBtn.classList.add('disabled');
            nextBtn.querySelector('button').style.pointerEvents = 'none';
        } else {
            nextBtn.classList.remove('disabled');
            nextBtn.querySelector('button').style.pointerEvents = 'auto';
        }
    }
    
    // Afficher/masquer la pagination
    const paginationContainer = document.getElementById('paginationContainer');
    if (paginationContainer) {
        if (totalCount > pageSize) {
            paginationContainer.style.display = 'block';
        } else {
            paginationContainer.style.display = 'none';
        }
    }
}

// Changer de page
function changePage(direction) {
    let newPage;
    if (direction === 'prev') {
        newPage = currentPage - 1;
    } else if (direction === 'next') {
        newPage = currentPage + 1;
    } else {
        newPage = currentPage + direction; // Support pour les valeurs num√©riques
    }
    
    if (newPage >= 1 && newPage <= totalPages) {
        console.log(`Changement de page: ${currentPage} ‚Üí ${newPage}`);
        applyFilters(newPage);
    } else {
        console.log(`Page invalide: ${newPage} (min: 1, max: ${totalPages})`);
    }
}

function formatNumber(num) {
    return new Intl.NumberFormat('fr-FR', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(num);
}

// Activer les boutons de g√©n√©ration
function enableGenerateButtons() {
    document.getElementById('generatePDF').disabled = false;
    document.getElementById('generateExcel').disabled = false;
    document.getElementById('generateBoth').disabled = false;
}

// R√©initialiser les filtres
function resetFilters() {
    // Ne PAS r√©initialiser le type d'√©tat !
    const typeEtat = document.getElementById('id_type_etat').value;
    const filtresDepenses = document.getElementById('filtres_depenses');
    const filtresRecettes = document.getElementById('filtres_recettes');
    
    // R√©initialiser seulement les filtres, pas le type d'√©tat
    if (filtresDepenses) {
        const selects = filtresDepenses.querySelectorAll('select');
        const inputs = filtresDepenses.querySelectorAll('input');
        selects.forEach(select => select.selectedIndex = 0);
        inputs.forEach(input => input.value = '');
    }
    
    if (filtresRecettes) {
        const selects = filtresRecettes.querySelectorAll('select');
        const inputs = filtresRecettes.querySelectorAll('input');
        selects.forEach(select => select.selectedIndex = 0);
        inputs.forEach(input => input.value = '');
    }
    
    document.getElementById('tableHeaders').innerHTML = '<th colspan="100%" class="text-center text-muted"><i class="bi bi-info-circle"></i> S√©lectionnez un type d\'√©tat et appliquez les filtres pour voir les r√©sultats</th>';
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="100%" class="text-center text-muted">Aucune donn√©e √† afficher</td></tr>';
    document.getElementById('totalRecords').textContent = '0';
    document.getElementById('totalUSD').textContent = '0.00';
    document.getElementById('totalCDF').textContent = '0.00';
    
    // D√©sactiver les boutons
    document.getElementById('generatePDF').disabled = true;
    document.getElementById('generateExcel').disabled = true;
    document.getElementById('generateBoth').disabled = true;
    
    console.log('ResetFilters ex√©cut√©, type √©tat pr√©serv√©:', typeEtat); // Debug
}

// Soumettre le formulaire en POST vers l'URL du rapport (tous les param√®tres sont envoy√©s)
function submitReportForm(actionUrl) {
    const form = document.getElementById('filterForm');
    const f = document.createElement('form');
    f.method = 'POST';
    f.action = actionUrl;
    f.target = '_blank';
    f.style.display = 'none';
    const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrf) {
        const c = document.createElement('input');
        c.name = 'csrfmiddlewaretoken';
        c.value = csrf.value;
        c.type = 'hidden';
        f.appendChild(c);
    }
    const typeEtat = document.getElementById('id_type_etat').value;
    const inputs = form.querySelectorAll('input, select');
    inputs.forEach(function(el) {
        if (!el.name) return;
        const include = (typeEtat === 'DEPENSE_FEUILLE' && (el.name.includes('_depenses') || el.name === 'type_etat')) ||
                        (typeEtat === 'RECETTE_FEUILLE' && (el.name.includes('_recettes') || el.name === 'type_etat'));
        if (!include) return;
        if (el.tagName === 'SELECT' && el.multiple) {
            Array.from(el.selectedOptions).forEach(function(opt) {
                const inp = document.createElement('input');
                inp.type = 'hidden';
                inp.name = el.name;
                inp.value = opt.value;
                f.appendChild(inp);
            });
        } else {
            const inp = document.createElement('input');
            inp.type = 'hidden';
            inp.name = el.name;
            inp.value = (el.value || '').toString();
            f.appendChild(inp);
        }
    });
    document.body.appendChild(f);
    f.submit();
    document.body.removeChild(f);
}

// G√©n√©rer l'√©tat (PDF ou Excel) : envoi de tous les param√®tres en POST
function generateState(format) {
    const typeEtat = document.getElementById('id_type_etat').value;
    const typeRapport = document.getElementById('id_type_rapport').value;
    const critereGroupement = document.getElementById('id_critere_groupement').value;
    
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Utiliser la nouvelle vue pour les rapports regroup√©s et synth√©tiques
    if (typeRapport === 'GROUPE' || typeRapport === 'SYNTHESE') {
        // Envoyer √† la nouvelle vue de g√©n√©ration
        const form = document.getElementById('filterForm');
        const formData = new FormData(form);
        formData.append('format_sortie', format);
        formData.append('type_rapport', typeRapport);
        if (typeRapport === 'GROUPE') {
            formData.append('critere_groupement', critereGroupement);
        }
        
        fetch('/tableau-bord-feuilles/generer-etats/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.type === 'SYNTHESE') {
                    // Ouvrir le PDF de synth√®se dans un nouvel onglet
                    const url = `/tableau-bord-feuilles/rapports/synthese/pdf/?data=${encodeURIComponent(JSON.stringify(data.data))}`;
                    window.open(url, '_blank');
                } else if (data.type === 'GROUPE') {
                    // Ouvrir le PDF de regroupement dans un nouvel onglet
                    const url = `/tableau-bord-feuilles/rapports/groupe/pdf/?data=${encodeURIComponent(JSON.stringify(data.data))}`;
                    window.open(url, '_blank');
                }
            } else {
                alert('Erreur: ' + data.error);
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la g√©n√©ration du rapport');
            document.getElementById('loadingOverlay').style.display = 'none';
        });
    } else {
        // Utiliser les vues existantes pour les rapports d√©taill√©s
        if (typeEtat === 'DEPENSE_FEUILLE') {
            const url = '/tableau-bord-feuilles/rapports/depense/pdf/';
            if (format === 'PDF' || format === 'EXCEL') {
                submitReportForm(url);
            }
        } else if (typeEtat === 'RECETTE_FEUILLE') {
            const url = '/tableau-bord-feuilles/rapports/recette/pdf/';
            if (format === 'PDF' || format === 'EXCEL') {
                submitReportForm(url);
            }
        } else {
            alert('Veuillez s√©lectionner un type d\'√©tat');
            document.getElementById('loadingOverlay').style.display = 'none';
            return;
        }
        setTimeout(function() { document.getElementById('loadingOverlay').style.display = 'none'; }, 1500);
    }
}

// G√©n√©rer le titre automatiquement
function generateTitle() {
    const typeEtatElement = document.getElementById('id_type_etat');
    if (!typeEtatElement) return 'Rapport';
    
    const typeEtat = typeEtatElement.value;
    const typeLabel = typeEtatElement.options[typeEtatElement.selectedIndex].text;
    
    // Les champs date ont √©t√© supprim√©s, donc on g√©n√®re un titre simple
    return `${typeLabel}`;
}

function formatDateFr(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('fr-FR', {day: 'numeric', month: 'long', year: 'numeric'});
}

// Helper pour obtenir le CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM charg√©'); // Debug
    
    // V√©rifier que l'√©l√©ment existe
    const typeEtatElement = document.getElementById('id_type_etat');
    console.log('√âl√©ment type √©tat:', typeEtatElement); // Debug
    
    if (typeEtatElement) {
        console.log('Valeur actuelle:', typeEtatElement.value); // Debug
    }
});
</script>
{% endblock %}
