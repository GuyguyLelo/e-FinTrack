{% extends 'base.html' %}
{% load format_filters %}

{% block title %}Sélectionner la banque - e-Finance DAF{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
            <div class="card-header text-white" style="background: linear-gradient(135deg, #1a3a5f 0%, #2a4a6f 100%);">
                <h5 class="mb-0">
                    <i class="bi bi-bank"></i> Sélectionner la banque pour le chèque
                </h5>
            </div>
            <div class="card-body">
                    <div class="alert alert-info mb-4">
                        <strong>Relevé :</strong> <span class="badge bg-primary">{{ releve.numero }}</span><br><br>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Montant total CDF :</strong><br>
                                <span class="text-success fw-bold fs-5">{{ releve.montant_cdf|format_montant:"CDF" }}</span><br>
                                <small class="text-muted fst-italic">{{ releve.montant_cdf|montant_en_lettres }}</small>
                            </div>
                            <div class="col-md-6">
                                <strong>Montant total USD :</strong><br>
                                <span class="text-primary fw-bold fs-5">{{ releve.montant_usd|format_montant:"USD" }}</span><br>
                                <small class="text-muted fst-italic">{{ releve.montant_usd|montant_en_lettres }}</small>
                            </div>
                        </div>
                    </div>
                    <p class="text-muted mb-4">
                        Veuillez sélectionner la banque pour laquelle le chèque sera généré.
                    </p>
                    <form method="get" action="{% url 'demandes:cheque_pdf' %}" id="banqueForm">
                        <input type="hidden" name="releve_id" value="{{ releve.pk }}">
                        <div class="mb-3">
                            <label for="banque_id" class="form-label">
                                <strong>Banque <span class="text-danger">*</span></strong>
                            </label>
                            <select name="banque_id" id="banque_id" class="form-select" required>
                                <option value="">-- Sélectionnez une banque --</option>
                                {% for banque in banques %}
                                <option value="{{ banque.pk }}">{{ banque.nom_banque }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Sélectionnez la banque pour laquelle le chèque sera généré
                            </small>
                        </div>
                        <div id="soldes-container" class="mb-3" style="display: none;">
                            <div class="alert alert-success border-0 shadow-sm">
                                <h6 class="alert-heading mb-3">
                                    <i class="bi bi-wallet2"></i> Soldes des comptes bancaires
                                </h6>
                                <div class="row">
                                    <div class="col-md-6" id="solde-cdf-container" style="display: none;">
                                        <strong class="text-muted">Solde CDF :</strong><br>
                                        <span id="solde-cdf" class="text-success fw-bold fs-5">-</span>
                                    </div>
                                    <div class="col-md-6" id="solde-usd-container" style="display: none;">
                                        <strong class="text-muted">Solde USD :</strong><br>
                                        <span id="solde-usd" class="text-primary fw-bold fs-5">-</span>
                                    </div>
                                </div>
                                <div id="loading-soldes" class="text-center text-muted" style="display: none;">
                                    <i class="bi bi-arrow-repeat spin"></i> Chargement des soldes...
                                </div>
                                <div id="no-comptes" class="text-center text-muted" style="display: none;">
                                    <i class="bi bi-info-circle"></i> Aucun compte actif trouvé pour cette banque
                                </div>
                            </div>
                        </div>
                        <div id="avertissement-container" class="mb-3" style="display: none;">
                            <div class="alert alert-warning border-0 shadow-sm">
                                <h6 class="alert-heading mb-3">
                                    <i class="bi bi-exclamation-triangle"></i> Avertissement : Solde insuffisant
                                </h6>
                                <div id="avertissement-content"></div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'demandes:releve_detail' releve.pk %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Annuler
                            </a>
                            <button type="submit" id="btn-generer-cheque" class="btn btn-warning" disabled>
                                <i class="bi bi-printer"></i> Générer le chèque
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const banqueSelect = document.getElementById('banque_id');
    const soldesContainer = document.getElementById('soldes-container');
    const soldeCdf = document.getElementById('solde-cdf');
    const soldeUsd = document.getElementById('solde-usd');
    const soldeCdfContainer = document.getElementById('solde-cdf-container');
    const soldeUsdContainer = document.getElementById('solde-usd-container');
    const btnGenererCheque = document.getElementById('btn-generer-cheque');
    
    // Fonction pour activer/désactiver le bouton
    function toggleBoutonGenerer(activer) {
        if (activer) {
            btnGenererCheque.disabled = false;
            btnGenererCheque.classList.remove('btn-secondary');
            btnGenererCheque.classList.add('btn-warning');
        } else {
            btnGenererCheque.disabled = true;
            btnGenererCheque.classList.remove('btn-warning');
            btnGenererCheque.classList.add('btn-secondary');
        }
    }
    
    banqueSelect.addEventListener('change', function() {
        const banqueId = this.value;
        const loadingSoldes = document.getElementById('loading-soldes');
        const noComptes = document.getElementById('no-comptes');
        
        const avertissementContainer = document.getElementById('avertissement-container');
        
        if (!banqueId) {
            soldesContainer.style.display = 'none';
            avertissementContainer.style.display = 'none';
            toggleBoutonGenerer(false);
            return;
        }
        
        // Afficher un indicateur de chargement
        soldesContainer.style.display = 'block';
        loadingSoldes.style.display = 'block';
        noComptes.style.display = 'none';
        soldeCdfContainer.style.display = 'none';
        soldeUsdContainer.style.display = 'none';
        avertissementContainer.style.display = 'none';
        toggleBoutonGenerer(false); // Désactiver pendant le chargement
        
        // Récupérer les montants totaux du relevé depuis le template
        const montantCdfReleve = parseFloat('{{ releve.montant_cdf }}') || 0;
        const montantUsdReleve = parseFloat('{{ releve.montant_usd }}') || 0;
        const releveId = '{{ releve.pk }}';
        
        // Récupérer les soldes via AJAX
        fetch(`{% url 'demandes:banque_soldes_api' %}?banque_id=${banqueId}&releve_id=${releveId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des soldes');
                }
                return response.json();
            })
            .then(data => {
                loadingSoldes.style.display = 'none';
                
                let hasComptes = false;
                const avertissementContent = document.getElementById('avertissement-content');
                
                // Afficher le solde CDF si disponible
                if (data.comptes && data.comptes.CDF) {
                    const soldeCdfValue = parseFloat(data.comptes.CDF.solde);
                    soldeCdf.textContent = formatMontant(soldeCdfValue, 'CDF');
                    soldeCdfContainer.style.display = 'block';
                    hasComptes = true;
                } else {
                    soldeCdfContainer.style.display = 'none';
                }
                
                // Afficher le solde USD si disponible
                if (data.comptes && data.comptes.USD) {
                    const soldeUsdValue = parseFloat(data.comptes.USD.solde);
                    soldeUsd.textContent = formatMontant(soldeUsdValue, 'USD');
                    soldeUsdContainer.style.display = 'block';
                    hasComptes = true;
                } else {
                    soldeUsdContainer.style.display = 'none';
                }
                
                // Vérifier les avertissements (écarts) pour les deux monnaies
                // Les montants sont déjà récupérés plus haut : montantCdfReleve et montantUsdReleve
                let hasAvertissement = false;
                
                // Vérifier que les deux montants sont inférieurs ou égaux aux soldes
                let compteCdf = data.comptes && data.comptes.CDF;
                let compteUsd = data.comptes && data.comptes.USD;
                
                // Vérifier CDF : le montant doit être inférieur ou égal au solde
                if (montantCdfReleve > 0) {
                    if (!compteCdf) {
                        hasAvertissement = true;
                        if (!data.avertissements) data.avertissements = {};
                        data.avertissements.CDF = {
                            montant_releve: montantCdfReleve,
                            solde: 0,
                            ecart: montantCdfReleve,
                            message: 'Aucun compte CDF actif trouvé pour cette banque'
                        };
                    } else if (compteCdf.solde < montantCdfReleve) {
                        hasAvertissement = true;
                        if (!data.avertissements) data.avertissements = {};
                        data.avertissements.CDF = {
                            montant_releve: montantCdfReleve,
                            solde: compteCdf.solde,
                            ecart: montantCdfReleve - compteCdf.solde
                        };
                    }
                }
                
                // Vérifier USD : le montant doit être inférieur ou égal au solde
                if (montantUsdReleve > 0) {
                    if (!compteUsd) {
                        hasAvertissement = true;
                        if (!data.avertissements) data.avertissements = {};
                        data.avertissements.USD = {
                            montant_releve: montantUsdReleve,
                            solde: 0,
                            ecart: montantUsdReleve,
                            message: 'Aucun compte USD actif trouvé pour cette banque'
                        };
                    } else if (compteUsd.solde < montantUsdReleve) {
                        hasAvertissement = true;
                        if (!data.avertissements) data.avertissements = {};
                        data.avertissements.USD = {
                            montant_releve: montantUsdReleve,
                            solde: compteUsd.solde,
                            ecart: montantUsdReleve - compteUsd.solde
                        };
                    }
                }
                
                // Afficher les avertissements
                if (data.avertissements && Object.keys(data.avertissements).length > 0) {
                    let avertissementHtml = '<ul class="mb-0">';
                    
                    if (data.avertissements.CDF) {
                        const avert = data.avertissements.CDF;
                        const montantReleve = formatMontant(avert.montant_releve, 'CDF');
                        const solde = formatMontant(avert.solde, 'CDF');
                        const ecart = formatMontant(avert.ecart, 'CDF');
                        const message = avert.message || '';
                        avertissementHtml += `<li class="mb-2">
                            <strong>CDF :</strong> Le montant du chèque (<span class="fw-bold">${montantReleve}</span>) 
                            ${avert.message ? `- ${message}` : `dépasse le solde disponible (<span class="fw-bold">${solde}</span>)`}. 
                            ${!avert.message ? `<span class="text-danger fw-bold">Écart: ${ecart}</span>` : ''}
                        </li>`;
                    }
                    
                    if (data.avertissements.USD) {
                        const avert = data.avertissements.USD;
                        const montantReleve = formatMontant(avert.montant_releve, 'USD');
                        const solde = formatMontant(avert.solde, 'USD');
                        const ecart = formatMontant(avert.ecart, 'USD');
                        const message = avert.message || '';
                        avertissementHtml += `<li class="mb-2">
                            <strong>USD :</strong> Le montant du chèque (<span class="fw-bold">${montantReleve}</span>) 
                            ${avert.message ? `- ${message}` : `dépasse le solde disponible (<span class="fw-bold">${solde}</span>)`}. 
                            ${!avert.message ? `<span class="text-danger fw-bold">Écart: ${ecart}</span>` : ''}
                        </li>`;
                    }
                    
                    avertissementHtml += '</ul>';
                    avertissementContent.innerHTML = avertissementHtml;
                    avertissementContainer.style.display = 'block';
                } else {
                    avertissementContainer.style.display = 'none';
                }
                
                // Activer/désactiver le bouton selon la présence d'avertissements
                // Le bouton est activé seulement si :
                // 1. Les comptes nécessaires existent (CDF si montantCdfReleve > 0, USD si montantUsdReleve > 0)
                // 2. Aucun avertissement de solde insuffisant (hasAvertissement = false)
                // 3. Les montants sont inférieurs ou égaux aux soldes correspondants
                let canGenerate = true;
                
                // Vérifier CDF : le montant doit être inférieur ou égal au solde
                if (montantCdfReleve > 0) {
                    if (!compteCdf || (compteCdf && compteCdf.solde < montantCdfReleve)) {
                        canGenerate = false;
                    }
                }
                
                // Vérifier USD : le montant doit être inférieur ou égal au solde
                if (montantUsdReleve > 0) {
                    if (!compteUsd || (compteUsd && compteUsd.solde < montantUsdReleve)) {
                        canGenerate = false;
                    }
                }
                
                // Au moins un compte doit exister si au moins un montant > 0
                if ((montantCdfReleve > 0 || montantUsdReleve > 0) && !hasComptes) {
                    canGenerate = false;
                }
                
                if (canGenerate && !hasAvertissement) {
                    toggleBoutonGenerer(true);
                } else {
                    toggleBoutonGenerer(false);
                }
                
                // Si aucun compte n'est disponible
                if (!hasComptes) {
                    noComptes.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                loadingSoldes.style.display = 'none';
                noComptes.style.display = 'block';
                noComptes.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Erreur lors du chargement des soldes';
                toggleBoutonGenerer(false);
            });
    });
    
    // Fonction pour formater les montants
    function formatMontant(montant, devise) {
        if (isNaN(montant)) {
            return '0,00';
        }
        
        // Formater avec séparateurs de milliers (espaces) et virgule pour les décimales
        const parts = montant.toFixed(2).split('.');
        const partieEntiere = parts[0];
        const partieDecimale = parts[1];
        
        // Ajouter des espaces comme séparateurs de milliers
        const partieEntiereFormatee = partieEntiere.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
        
        return `${partieEntiereFormatee},${partieDecimale} ${devise}`;
    }
});
</script>
<style>
.spin {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

