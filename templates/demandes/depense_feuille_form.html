{% extends 'base.html' %}

{% block title %}{% if object %}Modifier{% else %}Ajouter{% endif %} une dépense - e-FinTrack{% endblock %}

{% block extra_css %}
<style>
.depense-form-wrap {
    max-width: 900px;
    margin: 0 auto;
    background: #fef7f5;
    padding: 1.75rem;
    border-radius: 10px;
}
.depense-form-wrap .form-header {
    border-left: 4px solid #c2410c;
    padding-left: 1rem;
    margin-bottom: 1.75rem;
}
.depense-form-wrap .form-header h4 {
    margin: 0;
    font-weight: 700;
    font-size: 1.5rem;
    color: #1e293b;
    letter-spacing: -0.02em;
}
.depense-form-wrap .form-header h4 i {
    color: #c2410c;
    margin-right: 0.5rem;
}
.depense-form-wrap .form-section {
    border-left: 3px solid #c2410c;
    background: #fff;
    padding: 1.25rem 1.5rem;
    margin-bottom: 1.25rem;
    border-radius: 0 6px 6px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}
.depense-form-wrap .form-section-title {
    font-weight: 600;
    font-size: 0.9rem;
    color: #64748b;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
}
.depense-form-wrap .form-section-title i {
    color: #c2410c;
    margin-right: 0.4rem;
}
.depense-form-wrap .form-label {
    font-weight: 500;
    color: #475569;
    font-size: 0.9rem;
    margin-bottom: 0.35rem;
}
.depense-form-wrap .form-control,
.depense-form-wrap .form-select {
    border-radius: 4px;
    border: 1px solid #e2e8f0;
    padding: 0.5rem 0.75rem;
    font-size: 0.95rem;
    color: #0ea5e9;
    font-weight: 500;
}
.depense-form-wrap .form-control::placeholder {
    color: #94a3b8;
    font-weight: 400;
}
.depense-form-wrap .form-control:focus,
.depense-form-wrap .form-select:focus {
    border-color: #c2410c;
    box-shadow: 0 0 0 2px rgba(194, 65, 12, 0.2);
}
.depense-form-wrap textarea.form-control { min-height: 85px; resize: vertical; }
.depense-form-wrap .btn-actions {
    margin-top: 1.5rem;
    padding-top: 1.25rem;
    border-top: 1px solid #e2e8f0;
}
.depense-form-wrap .btn-submit { font-weight: 600; }
.depense-form-wrap .invalid-feedback { font-size: 0.8rem; }
.depense-form-wrap .ts-wrapper .ts-control {
    border-radius: 4px;
    border: 1px solid #e2e8f0;
}
.depense-form-wrap .ts-wrapper .ts-control input,
.depense-form-wrap .ts-wrapper .ts-control .item {
    color: #0ea5e9;
    font-weight: 500;
}
.depense-form-wrap .ts-wrapper.focus .ts-control {
    border-color: #c2410c;
    box-shadow: 0 0 0 2px rgba(194, 65, 12, 0.2);
}
</style>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2/dist/css/tom-select.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-11 offset-lg-0 col-xl-10 offset-xl-1">
        <div class="depense-form-wrap">
            <div class="form-header">
                <h4><i class="bi bi-arrow-down-circle"></i> {% if object %}Modifier{% else %}Ajouter{% endif %} une dépense</h4>
            </div>
                <form method="post">
                    {% csrf_token %}
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <div class="form-section">
                        <div class="form-section-title"><i class="bi bi-calendar3"></i> Période</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="id_mois" class="form-label">Mois</label>
                                {{ form.mois }}
                                {% if form.mois.errors %}<div class="invalid-feedback d-block">{{ form.mois.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="id_annee" class="form-label">Année</label>
                                {{ form.annee }}
                                {% if form.annee.errors %}<div class="invalid-feedback d-block">{{ form.annee.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="id_date" class="form-label">Date</label>
                                {{ form.date }}
                                <div id="date-coherence-msg" class="invalid-feedback d-block" style="display: none;"></div>
                                {% if form.date.errors %}<div class="invalid-feedback d-block">{{ form.date.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title"><i class="bi bi-building"></i> Bénéficiaire, nature, banque et montants</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_service_beneficiaire" class="form-label">Service bénéficiaire</label>
                                {{ form.service_beneficiaire }}
                                {% if form.service_beneficiaire.errors %}<div class="invalid-feedback d-block">{{ form.service_beneficiaire.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="id_nature_economique" class="form-label">Article Littera</label>
                                {{ form.nature_economique }}
                                {% if form.nature_economique.errors %}<div class="invalid-feedback d-block">{{ form.nature_economique.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                        <div class="row g-3 mt-0">
                            <div class="col-md-6">
                                <label for="id_banque" class="form-label">Banque</label>
                                {{ form.banque }}
                                {% if form.banque.errors %}<div class="invalid-feedback d-block">{{ form.banque.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-3">
                                <label for="id_montant_fc" class="form-label">Montant FC</label>
                                {{ form.montant_fc }}
                                {% if form.montant_fc.errors %}<div class="invalid-feedback d-block">{{ form.montant_fc.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-md-3">
                                <label for="id_montant_usd" class="form-label">Montant $us</label>
                                {{ form.montant_usd }}
                                {% if form.montant_usd.errors %}<div class="invalid-feedback d-block">{{ form.montant_usd.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-12">
                                <label for="id_libelle_depenses" class="form-label">Libellé dépenses</label>
                                {{ form.libelle_depenses }}
                                {% if form.libelle_depenses.errors %}<div class="invalid-feedback d-block">{{ form.libelle_depenses.errors.0 }}</div>{% endif %}
                            </div>
                            <div class="col-12">
                                <label for="id_observation" class="form-label">Observation</label>
                                {{ form.observation }}
                                {% if form.observation.errors %}<div class="invalid-feedback d-block">{{ form.observation.errors.0 }}</div>{% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="btn-actions d-flex flex-wrap gap-2 align-items-center">
                        <button type="submit" class="btn btn-primary btn-submit" style="background:#c2410c;border-color:#c2410c"><i class="bi bi-check-lg me-1"></i> Enregistrer</button>
                        <a href="{% url 'demandes:depense_feuille_liste' %}" class="btn btn-light btn-submit">Annuler</a>
                        <a href="{% url 'demandes:depense_feuille_liste' %}" class="btn btn-link text-secondary"><i class="bi bi-arrow-left me-1"></i> Retour</a>
                    </div>
                </form>
        </div>
    </div>
</div>
<script>
(function() {
    var moisEl = document.getElementById('id_mois');
    var anneeEl = document.getElementById('id_annee');
    var dateEl = document.getElementById('id_date');
    var msgEl = document.getElementById('date-coherence-msg');
    var formEl = dateEl && dateEl.closest('form');

    function checkDateCoherence() {
        if (!moisEl || !anneeEl || !dateEl || !msgEl) return true;
        var mois = parseInt(moisEl.value, 10);
        var annee = parseInt(anneeEl.value, 10);
        var dateStr = dateEl.value;
        if (!dateStr || isNaN(mois) || isNaN(annee) || mois < 1 || mois > 12) {
            msgEl.style.display = 'none';
            dateEl.classList.remove('is-invalid');
            return true;
        }
        var d = new Date(dateStr);
        if (isNaN(d.getTime())) {
            msgEl.style.display = 'none';
            return true;
        }
        var dateMois = d.getMonth() + 1;
        var dateAnnee = d.getFullYear();
        if (dateMois !== mois || dateAnnee !== annee) {
            msgEl.textContent = 'La date doit correspondre au mois et à l\'année choisis (mois ' + mois + ' / année ' + annee + ').';
            msgEl.style.display = 'block';
            dateEl.classList.add('is-invalid');
            return false;
        }
        msgEl.style.display = 'none';
        dateEl.classList.remove('is-invalid');
        return true;
    }

    if (dateEl) {
        dateEl.addEventListener('change', checkDateCoherence);
        dateEl.addEventListener('input', checkDateCoherence);
    }
    if (moisEl) moisEl.addEventListener('change', checkDateCoherence);
    if (anneeEl) anneeEl.addEventListener('change', checkDateCoherence);

    if (formEl) {
        formEl.addEventListener('submit', function(e) {
            if (!checkDateCoherence()) {
                e.preventDefault();
                dateEl.focus();
            }
        });
    }
})();
</script>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/tom-select@2/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var el = document.getElementById('id_nature_economique');
    if (el && typeof TomSelect !== 'undefined') {
        new TomSelect(el, {
            create: false,
            placeholder: 'Rechercher ou choisir une nature...',
            allowEmptyOption: true,
            maxOptions: null,
            searchField: ['text'],
            render: {
                no_results: function() { return 'Aucun résultat'; }
            }
        });
    }
});
</script>
{% endblock %}
