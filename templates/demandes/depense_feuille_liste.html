{% extends 'base.html' %}
{% load format_filters %}

{% block title %}Dépenses (feuille) - e-FinTrack{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-file-earmark-spreadsheet"></i> Dépenses – Feuille (structure Excel)</h2>
    <div class="d-flex align-items-center gap-3">
        {% if user.peut_saisir_demandes_recettes %}
        <a href="{% url 'demandes:depense_feuille_creer' %}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Ajouter une ligne
        </a>
        {% endif %}
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-info fs-6 px-3 py-2">
                <strong>Total FC:</strong> {{ total_fc|format_montant }} FC
            </span>
            <span class="badge bg-primary fs-6 px-3 py-2">
                <strong>Total $us:</strong> {{ total_usd|format_montant }} $us
            </span>
        </div>
    </div>
</div>

<p class="text-muted mb-3">
    Structure correspondant à la feuille <strong>DEPENSES</strong> du fichier Excel : MOIS, ANNEE, DATE, ARTICLE LITTERA, LIBELLE DEPENSES, BANQUE, MONTANT EN Fc, MONTANT EN $us, OBSERVATION.
</p>

<!-- Filtres -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtres</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label for="annee" class="form-label">Année</label>
                <select name="annee" id="annee" class="form-select">
                    <option value="">Toutes</option>
                    {% for a in annees %}
                    <option value="{{ a }}" {% if filtres.annee == a|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="mois" class="form-label">Mois</label>
                <select name="mois" id="mois" class="form-select">
                    <option value="">Tous</option>
                    <option value="1"  {% if filtres.mois == "1"  %}selected{% endif %}>Janvier</option>
                    <option value="2"  {% if filtres.mois == "2"  %}selected{% endif %}>Février</option>
                    <option value="3"  {% if filtres.mois == "3"  %}selected{% endif %}>Mars</option>
                    <option value="4"  {% if filtres.mois == "4"  %}selected{% endif %}>Avril</option>
                    <option value="5"  {% if filtres.mois == "5"  %}selected{% endif %}>Mai</option>
                    <option value="6"  {% if filtres.mois == "6"  %}selected{% endif %}>Juin</option>
                    <option value="7"  {% if filtres.mois == "7"  %}selected{% endif %}>Juillet</option>
                    <option value="8"  {% if filtres.mois == "8"  %}selected{% endif %}>Août</option>
                    <option value="9"  {% if filtres.mois == "9"  %}selected{% endif %}>Septembre</option>
                    <option value="10" {% if filtres.mois == "10" %}selected{% endif %}>Octobre</option>
                    <option value="11" {% if filtres.mois == "11" %}selected{% endif %}>Novembre</option>
                    <option value="12" {% if filtres.mois == "12" %}selected{% endif %}>Décembre</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="banque" class="form-label">Banque</label>
                <select name="banque" id="banque" class="form-select">
                    <option value="">Toutes</option>
                    {% for banque in banques %}
                    <option value="{{ banque.pk }}" {% if filtres.banque == banque.pk|stringformat:"s" %}selected{% endif %}>{{ banque.nom_banque }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary"><i class="bi bi-search"></i> Filtrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Liste -->
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Service bénéficiaire</th>
                        <th>Nature économique</th>
                        <th>Libellé dépenses</th>
                        <th>Banque</th>
                        <th class="text-end">Montant FC</th>
                        <th class="text-end">Montant $us</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for ligne in lignes %}
                    <tr>
                        <td>{{ ligne.date|date:"d/m/Y" }}</td>
                        <td>{{ ligne.service_beneficiaire.nom_service|default:"—" }}</td>
                        <td>{{ ligne.nature_economique|default:"—" }}</td>
                        <td>{{ ligne.libelle_depenses|truncatewords:10 }}</td>
                        <td>{{ ligne.banque.nom_banque|default:"—" }}</td>
                        <td class="text-end">{{ ligne.montant_fc|format_montant }}</td>
                        <td class="text-end">{{ ligne.montant_usd|format_montant }}</td>
                        <td>
                            <a href="{% url 'demandes:depense_feuille_detail' ligne.pk %}" class="btn btn-sm btn-info" title="Voir"><i class="bi bi-eye"></i></a>
                            {% if user.peut_saisir_demandes_recettes %}
                            <a href="{% url 'demandes:depense_feuille_modifier' ligne.pk %}" class="btn btn-sm btn-warning" title="Modifier"><i class="bi bi-pencil"></i></a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mt-2">Aucune ligne dépense (feuille).</p>
                            {% if user.peut_saisir_demandes_recettes %}
                            <a href="{% url 'demandes:depense_feuille_creer' %}" class="btn btn-primary btn-sm">Ajouter une ligne</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-3">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filtres.annee %}&annee={{ filtres.annee }}{% endif %}{% if filtres.mois %}&mois={{ filtres.mois }}{% endif %}{% if filtres.banque %}&banque={{ filtres.banque }}{% endif %}">Précédent</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filtres.annee %}&annee={{ filtres.annee }}{% endif %}{% if filtres.mois %}&mois={{ filtres.mois }}{% endif %}{% if filtres.banque %}&banque={{ filtres.banque }}{% endif %}">Suivant</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<div class="mt-3">
    <a href="{% url 'demandes:depenses_liste' %}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Retour aux Dépenses</a>
</div>
{% endblock %}
