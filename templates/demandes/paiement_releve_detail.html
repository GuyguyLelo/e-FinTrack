{% extends 'base.html' %}
{% load humanize %}
{% load format_filters %}

{% block title %}{{ title }} - e-Finance DAF{% endblock %}

{% block extra_css %}
<style>
    .releve-header {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 1.5rem;
    }
    
    .releve-info-card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .demande-card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 1rem;
        transition: transform 0.2s;
    }
    
    .demande-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .demande-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        padding: 1rem;
        border-radius: 8px 8px 0 0;
    }
    
    .demande-title {
        font-weight: 600;
        color: #1a3a5f;
        margin-bottom: 0.5rem;
    }
    
    .montant-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .montant-row:last-child {
        border-bottom: none;
        font-weight: 600;
        background-color: #e3f2fd;
        margin: 0.5rem 0;
        padding: 0.75rem;
        border-radius: 5px;
    }
    
    .montant-label {
        font-weight: 500;
    }
    
    .montant-value {
        font-weight: 600;
    }
    
    .montant-total {
        font-size: 1.2rem;
        color: #28a745;
    }
    
    .reste-a-payer {
        color: #ffffff;
        font-weight: 600;
    }
    
    .deja-paye {
        color: #28a745;
        font-weight: 600;
    }
    
    .paiement-form {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0 0 8px 8px;
    }
    
    .alert-montant {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 0.75rem;
        margin-top: 0.5rem;
        border-radius: 0 5px 5px 0;
        font-size: 0.9rem;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #1a3a5f 0%, #2a4a6f 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        gap: 1rem;
    }
    
    .summary-item span:first-child {
        flex: 1 1 auto;
        min-width: 0;
    }
    
    .summary-item span:last-child {
        flex: 0 0 auto;
        text-align: right;
        white-space: nowrap;
        font-weight: 600;
    }
    
    .summary-item:last-child {
        border-bottom: none;
        font-size: 1.2rem;
        font-weight: 600;
        margin-top: 0.5rem;
        padding-top: 1rem;
        border-top: 2px solid rgba(255, 255, 255, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h3 text-dark">
                    <i class="fas fa-money-check-alt text-success me-2"></i>
                    {{ title }}
                </h2>
                <div>
                    <a href="{% url 'demandes:paiement_par_releve' %}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left me-1"></i> Changer de relevé
                    </a>
                    <a href="{% url 'demandes:paiement_liste' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-1"></i> Tous les paiements
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Résumé des paiements -->
    <div class="row">
        <div class="col-lg-3">
            <div class="summary-card">
                <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i>Résumé des demandes</h5>
                <div class="summary-item">
                    <span>Montant total initial:</span>
                    <span>{{ total_initial|format_montant:devise_releve }}</span>
                </div>
                <div class="summary-item">
                    <span>Déjà payé:</span>
                    <span class="deja-paye">{{ total_deja_paye|format_montant:devise_releve }}</span>
                </div>
                <div class="summary-item">
                    <span>Total à payer:</span>
                    <span class="reste-a-payer">{{ total_a_payer|format_montant:devise_releve }}</span>
                </div>
            </div>
            
            <!-- Liste des demandes du relevé (version simplifiée) -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>Liste des demandes ({{ toutes_demandes.count }})</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 400px; overflow-y: auto;">
                        {% for demande in toutes_demandes %}
                        <div class="list-group-item py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <strong class="small">{{ demande.reference }}</strong>
                                    <span class="badge bg-{% if demande.statut == 'PAYEE' %}success{% elif demande.statut == 'VALIDEE_DG' or demande.statut == 'VALIDEE_DF' %}primary{% else %}warning{% endif %} ms-2" style="font-size: 0.7rem;">
                                        {{ demande.get_statut_display|slice:":3" }}
                                    </span>
                                    <br>
                                    <small class="text-muted">{{ demande.service_demandeur.nom_service|truncatechars:25 }}</small>
                                </div>
                                <div class="text-end">
                                    <small class="d-block">
                                        <span class="text-muted">Reste:</span>
                                        <strong class="{% if demande.reste_a_payer > 0 %}text-danger{% else %}text-success{% endif %}">
                                            {{ demande.reste_a_payer|format_montant:demande.devise }}
                                        </strong>
                                    </small>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="list-group-item text-center text-muted py-3">
                            <p class="mb-0">Aucune demande dans ce relevé</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            {% if demandes %}
            <form method="post" id="paiementMultipleForm">
                {% csrf_token %}
                <input type="hidden" name="demande_pk" id="demande_pk" value="">
                
                <!-- Liste des demandes -->
                {% for demande in demandes %}
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ demande.reference }}</strong> - {{ demande.service_demandeur.nom_service }}
                                <span class="badge bg-{% if demande.statut == 'PAYEE' %}success{% elif demande.statut == 'VALIDEE_DG' or demande.statut == 'VALIDEE_DF' %}primary{% else %}warning{% endif %} ms-2">
                                    {{ demande.get_statut_display }}
                                </span>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Reste à payer: <strong class="text-primary fw-bold">{{ demande.reste_a_payer|format_montant:demande.devise }}</strong></small>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label fw-bold">
                                    Montant à payer <span class="text-danger">*</span>
                                </label>
                                <input type="number" 
                                       name="montant_{{ demande.pk }}" 
                                       id="montant_{{ demande.pk }}"
                                       class="form-control" 
                                       value="{{ demande.reste_a_payer|floatformat:2 }}"
                                       step="0.01" 
                                       min="0.01" 
                                       max="{{ demande.reste_a_payer|floatformat:2 }}"
                                       data-demande="{{ demande.pk }}"
                                       data-reste="{{ demande.reste_a_payer|floatformat:2 }}"
                                       required>
                                <small class="text-muted">Max: {{ demande.reste_a_payer|format_montant:demande.devise }}</small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">
                                    Bénéficiaire <span class="text-danger">*</span>
                                </label>
                                <input type="text" 
                                       name="beneficiaire_{{ demande.pk }}" 
                                       id="beneficiaire_{{ demande.pk }}"
                                       class="form-control" 
                                       placeholder="Nom du bénéficiaire..."
                                       required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Observations</label>
                                <textarea name="observations_{{ demande.pk }}" 
                                          class="form-control" 
                                          rows="2" 
                                          placeholder="Observations..."></textarea>
                            </div>
                            <div class="col-md-2">
                                <button type="button" 
                                        onclick="payerDemande({{ demande.pk }}, '{{ demande.devise }}')"
                                        id="btn_payer_{{ demande.pk }}"
                                        class="btn btn-success w-100">
                                    <i class="fas fa-check me-1"></i> Payer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </form>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
                <h4>Aucune demande à payer</h4>
                <p class="text-muted">Toutes les demandes validées ont été entièrement payées pour ce relevé.</p>
                <a href="{% url 'demandes:paiement_par_releve' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Choisir un autre relevé
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Définir payerDemande dans le scope global pour qu'elle soit accessible depuis onclick
function payerDemande(demandePk, devise) {
        // Récupérer les valeurs du formulaire pour cette demande
        const montantInput = document.getElementById('montant_' + demandePk);
        const beneficiaireInput = document.getElementById('beneficiaire_' + demandePk);
        const observationsInput = document.querySelector('textarea[name="observations_' + demandePk + '"]');
        
        if (!montantInput || !beneficiaireInput) {
            alert('Erreur: Impossible de trouver les champs du formulaire.');
            return;
        }
        
        const montant = montantInput.value;
        const beneficiaire = beneficiaireInput.value;
        const observations = observationsInput ? observationsInput.value : '';
        
        // Validation
        if (!montant || parseFloat(montant) <= 0) {
            alert('Veuillez saisir un montant valide.');
            montantInput.focus();
            return;
        }
        
        if (!beneficiaire || beneficiaire.trim() === '') {
            alert('Veuillez saisir le bénéficiaire.');
            beneficiaireInput.focus();
            return;
        }
        
        // Afficher la modale de confirmation
        const modalElement = document.getElementById('confirmerPaiementModal');
        if (!modalElement) {
            alert('Erreur: Modale de confirmation introuvable.');
            return;
        }
        
        const modal = new bootstrap.Modal(modalElement);
        
        // Remplir les informations dans la modale
        document.getElementById('paiement-montant').textContent = parseFloat(montant).toFixed(2) + ' ' + devise;
        document.getElementById('paiement-beneficiaire').textContent = beneficiaire;
        document.getElementById('paiement-demande').textContent = demandePk;
        
        // Stocker les données pour la confirmation
        window.paiementData = {
            demandePk: demandePk,
            montant: montant,
            beneficiaire: beneficiaire,
            devise: devise
        };
        
        // Afficher la modale
        modal.show();
}

// Code exécuté au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM chargé - Initialisation des gestionnaires d\'événements');
    
    // Vérifier que Bootstrap est disponible
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap n\'est pas chargé!');
        return;
    }
    
    // Ajouter le gestionnaire pour le bouton de confirmation dans la modale
    const confirmerBtn = document.getElementById('confirmerPaiementBtn');
    console.log('Bouton confirmerPaiementBtn trouvé:', !!confirmerBtn);
    
    if (confirmerBtn) {
        confirmerBtn.addEventListener('click', function() {
            console.log('Clic sur le bouton confirmerPaiementBtn');
            
            if (!window.paiementData) {
                alert('Erreur: Données de paiement non trouvées.');
                return;
            }
            
            const { demandePk, montant, beneficiaire, devise } = window.paiementData;
            console.log('Données de paiement:', { demandePk, montant, beneficiaire, devise });
            
            // Fermer la modale
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('confirmerPaiementModal'));
            if (modalInstance) {
                modalInstance.hide();
            }
            
            // Créer un formulaire temporaire pour soumettre le paiement individuel
            const form = document.getElementById('paiementMultipleForm');
            if (!form) {
                alert('Erreur: Formulaire introuvable.');
                return;
            }
            
            // S'assurer que le champ demande_pk existe
            let demandePkInput = document.getElementById('demande_pk');
            if (!demandePkInput) {
                // Créer le champ s'il n'existe pas
                demandePkInput = document.createElement('input');
                demandePkInput.type = 'hidden';
                demandePkInput.name = 'demande_pk';
                demandePkInput.id = 'demande_pk';
                form.appendChild(demandePkInput);
            }
            demandePkInput.value = demandePk;
            
            // S'assurer que les valeurs sont bien dans le formulaire
            // Les champs avec les noms montant_{pk}, beneficiaire_{pk}, etc. sont déjà dans le formulaire
            // donc ils seront automatiquement inclus lors de la soumission
            
            // Vérifier que le formulaire a bien le token CSRF
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken) {
                alert('Erreur: Token CSRF manquant. Veuillez recharger la page.');
                return;
            }
            
            console.log('Soumission du formulaire...');
            // Soumettre le formulaire
            try {
                form.submit();
            } catch (error) {
                console.error('Erreur lors de la soumission du formulaire:', error);
                alert('Erreur lors de la soumission du formulaire. Veuillez réessayer.');
            }
        });
        
        console.log('Gestionnaire d\'événements attaché au bouton confirmerPaiementBtn');
    } else {
        console.error('Bouton confirmerPaiementBtn non trouvé!');
    }
    
    const montantInputs = document.querySelectorAll('input[name^="montant_"]');
    
    function validateMontant(input) {
        const maxMontant = parseFloat(input.dataset.reste);
        const montant = parseFloat(input.value);
        
        if (montant > maxMontant) {
            input.value = maxMontant.toFixed(2);
            showAlert('warning', `Le montant ne peut pas dépasser ${maxMontant.toFixed(2)}`);
        }
        
        if (montant < 0) {
            input.value = '0.00';
        }
    }
    
    function showAlert(type, message) {
        // Créer une alerte temporaire
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-suppression après 3 secondes
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }
    
    montantInputs.forEach(input => {
        input.addEventListener('input', function() {
            validateMontant(this);
        });
        
        input.addEventListener('blur', function() {
            if (this.value === '') {
                this.value = '0.00';
            }
            validateMontant(this);
        });
    });
});
</script>

<!-- Modal de confirmation de paiement -->
<div class="modal fade" id="confirmerPaiementModal" tabindex="-1" aria-labelledby="confirmerPaiementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="confirmerPaiementModalLabel">
                    <i class="bi bi-cash-coin"></i> Confirmer le paiement
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Confirmation de paiement</strong>
                </div>
                <p>Êtes-vous sûr de vouloir effectuer ce paiement ?</p>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Montant:</strong> <span id="paiement-montant" class="text-success fw-bold"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Bénéficiaire:</strong> <span id="paiement-beneficiaire" class="fw-bold"></span>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <strong>Demande:</strong> <span id="paiement-demande"></span>
                    </div>
                </div>
                <hr>
                <p class="text-muted mb-0">
                    <small><i class="bi bi-exclamation-triangle"></i> 
                    Cette action enregistrera le paiement et mettra à jour les soldes bancaires.</small>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Annuler
                </button>
                <button type="button" class="btn btn-success" id="confirmerPaiementBtn">
                    <i class="bi bi-cash-coin"></i> Confirmer le paiement
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
