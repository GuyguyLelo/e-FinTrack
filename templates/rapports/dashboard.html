{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load humanize %}
{% load format_filters %}

{% block title %}Tableau de Bord - e-Finance DAF{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-speedometer2"></i> Tableau de Bord</h2>

<!-- Statistiques -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h6 class="text-muted">Solde USD (Consolidé)</h6>
                <div class="stat-value">{{ solde_consolide_usd|default:0|format_montant_simple }} USD</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h6 class="text-muted">Solde CDF (Consolidé)</h6>
                <div class="stat-value">{{ solde_consolide_cdf|default:0|format_montant_simple }} CDF</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h6 class="text-muted">Recettes (mois)</h6>
                <div class="stat-value">
                    {{ recettes_mois_usd|default:0|format_montant_simple }} USD<br>
                    <small>{{ recettes_mois_cdf|default:0|format_montant_simple }} CDF</small>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card">
            <div class="card-body">
                <h6 class="text-muted">Dépenses (mois)</h6>
                <div class="stat-value">
                    {{ depenses_mois_usd|default:0|format_montant_simple }} USD<br>
                    <small>{{ depenses_mois_cdf|default:0|format_montant_simple }} CDF</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5>{{ total_demandes }}</h5>
                <p class="text-muted mb-0">Demandes totales</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5>{{ demandes_en_attente }}</h5>
                <p class="text-muted mb-0">En attente</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5>{{ demandes_validees }}</h5>
                <p class="text-muted mb-0">Demandes validées</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5>{{ releves_en_attente }}</h5>
                <p class="text-muted mb-0">Relevés en attente</p>
            </div>
        </div>
    </div>
</div>


<!-- Tableau des Soldes par Banque -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-table"></i> Détail des Soldes par Banque (Tableau)</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Banque</th>
                                <th class="text-end">Solde USD</th>
                                <th class="text-end">Solde CDF</th>
                                <th class="text-end">Total (USD)</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for banque_data in banques_avec_solde %}
                            <tr>
                                <td>
                                    <strong>{{ banque_data.nom }}</strong>
                                </td>
                                <td class="text-end">
                                    {% if banque_data.solde_usd > 0 %}
                                    <span class="text-success">{{ banque_data.solde_usd|format_montant:"USD" }}</span>
                                    {% else %}
                                    <span class="text-muted">0,00 USD</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if banque_data.solde_cdf > 0 %}
                                    <span class="text-primary">{{ banque_data.solde_cdf|format_montant:"CDF" }}</span>
                                    {% else %}
                                    <span class="text-muted">0,00 CDF</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if banque_data.solde_usd > 0 %}
                                    <strong class="text-success">{{ banque_data.solde_usd|format_montant:"USD" }}</strong>
                                    {% else %}
                                    <span class="text-muted">0,00 USD</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if banque_data.solde_usd > 0 or banque_data.solde_cdf > 0 %}
                                    <span class="badge bg-success">Actif</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Solde nul</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">
                                    <i class="bi bi-inbox"></i> Aucun solde disponible
                                </td>
                            </tr>
                            {% endfor %}
                            
                            <!-- Ligne de total -->
                            {% if banques_avec_solde %}
                            <tr class="table-info fw-bold">
                                <td>Total Consolidé</td>
                                <td class="text-end">{{ solde_consolide_usd|format_montant:"USD" }}</td>
                                <td class="text-end">{{ solde_consolide_cdf|format_montant:"CDF" }}</td>
                                <td class="text-end">{{ solde_consolide_usd|format_montant:"USD" }}</td>
                                <td>
                                    <span class="badge bg-info">Global</span>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Graphique Recettes et Dépenses
    const chartRecettesDepensesEl = document.getElementById('chartRecettesDepenses');
    if (chartRecettesDepensesEl) {
    const ctx1 = chartRecettesDepensesEl.getContext('2d');
    new Chart(ctx1, {
    type: 'line',
    data: {
        labels: {{ mois_labels|safe|escapejs }},
        datasets: [
            {
                label: 'Recettes USD',
                data: {{ recettes_usd_data|safe }},
                borderColor: 'rgb(40, 167, 69)',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.3
            },
            {
                label: 'Recettes CDF',
                data: {{ recettes_cdf_data|safe }},
                borderColor: 'rgb(23, 162, 184)',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.3
            },
            {
                label: 'Dépenses USD',
                data: {{ depenses_usd_data|safe }},
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.3
            },
            {
                label: 'Dépenses CDF',
                data: {{ depenses_cdf_data|safe }},
                borderColor: 'rgb(255, 193, 7)',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.3
            }
        ]
    },
    options: {
        responsive: true,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            // Formater les nombres avec séparateurs de milliers
                            label += new Intl.NumberFormat('fr-FR', {
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 2
                            }).format(context.parsed.y);
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return new Intl.NumberFormat('fr-FR', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(value);
                    }
                }
            }
        }
    }
});
    }

});
</script>
{% endblock %}

