{% extends 'base.html' %}
{% load format_filters %}

{% block title %}Recettes (feuille) - e-FinTrack{% endblock %}

{% block extra_css %}
<style>
.liste-compacte .table { font-size: 0.85rem; }
.liste-compacte .table th, .liste-compacte .table td { padding: 0.35rem 0.5rem; vertical-align: middle; }
.liste-compacte .card-body { padding: 0.5rem 1rem; }
.liste-compacte .btn-sm { padding: 0.2rem 0.4rem; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h2><i class="bi bi-file-earmark-spreadsheet"></i> Recettes </h2>
    {% if user.peut_saisir_demandes_recettes %}
    <a href="{% url 'recettes:feuille_creer' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Ajouter une recette
    </a>
    {% endif %}
</div>

<!-- <p class="text-muted mb-3">
    Structure correspondant à la feuille <strong>RECETTES</strong> du fichier Excel : MOIS, ANNEE, DATE, LIBELLE RECETTE, BANQUE, MONTANT FC, MONTANT $us.
</p> -->

<!-- Filtres -->
<div class="card mb-2 liste-compacte">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-funnel"></i> Filtres</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-2">
            <div class="col-md-2">
                <label for="annee" class="form-label">Année</label>
                <select name="annee" id="annee" class="form-select">
                    <option value="">Toutes</option>
                    {% for a in annees %}
                    <option value="{{ a }}" {% if filtres.annee == a|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="mois" class="form-label">Mois</label>
                <select name="mois" id="mois" class="form-select">
                    <option value="">Tous</option>
                    <option value="1"  {% if filtres.mois == "1"  %}selected{% endif %}>Janvier</option>
                    <option value="2"  {% if filtres.mois == "2"  %}selected{% endif %}>Février</option>
                    <option value="3"  {% if filtres.mois == "3"  %}selected{% endif %}>Mars</option>
                    <option value="4"  {% if filtres.mois == "4"  %}selected{% endif %}>Avril</option>
                    <option value="5"  {% if filtres.mois == "5"  %}selected{% endif %}>Mai</option>
                    <option value="6"  {% if filtres.mois == "6"  %}selected{% endif %}>Juin</option>
                    <option value="7"  {% if filtres.mois == "7"  %}selected{% endif %}>Juillet</option>
                    <option value="8"  {% if filtres.mois == "8"  %}selected{% endif %}>Août</option>
                    <option value="9"  {% if filtres.mois == "9"  %}selected{% endif %}>Septembre</option>
                    <option value="10" {% if filtres.mois == "10" %}selected{% endif %}>Octobre</option>
                    <option value="11" {% if filtres.mois == "11" %}selected{% endif %}>Novembre</option>
                    <option value="12" {% if filtres.mois == "12" %}selected{% endif %}>Décembre</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="date_debut" class="form-label">Date début</label>
                <input type="date" name="date_debut" id="date_debut" class="form-control" value="{{ filtres.date_debut }}">
            </div>
            <div class="col-md-2">
                <label for="date_fin" class="form-label">Date fin</label>
                <input type="date" name="date_fin" id="date_fin" class="form-control" value="{{ filtres.date_fin }}">
            </div>
            <div class="col-md-2">
                <label for="banque" class="form-label">Banque</label>
                <select name="banque" id="banque" class="form-select">
                    <option value="">Toutes</option>
                    {% for banque in banques %}
                    <option value="{{ banque.pk }}" {% if filtres.banque == banque.pk|stringformat:"s" %}selected{% endif %}>{{ banque.nom_banque }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary"><i class="bi bi-search"></i> Filtrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Liste -->
<div class="card liste-compacte">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped table-sm mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Mois</th>
                        <th>Année</th>
                        <th>Date</th>
                        <th>Libellé recette</th>
                        <th>Banque</th>
                        <th class="text-end">Montant FC</th>
                        <th class="text-end">Montant $us</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ligne in lignes %}
                    <tr>
                        <td>{{ ligne.mois|mois_en_lettres }}</td>
                        <td>{{ ligne.annee }}</td>
                        <td>{{ ligne.date|date:"d/m/Y" }}</td>
                        <td>{{ ligne.libelle_recette|truncatewords:8 }}</td>
                        <td>{{ ligne.banque.nom_banque|default:"—" }}</td>
                        <td class="text-end">{{ ligne.montant_fc|format_montant }}</td>
                        <td class="text-end">{{ ligne.montant_usd|format_montant }}</td>
                        <td>
                            <a href="{% url 'recettes:feuille_detail' ligne.pk %}" class="btn btn-sm btn-info" title="Voir"><i class="bi bi-eye"></i></a>
                            {% if user.peut_saisir_demandes_recettes %}
                            <a href="{% url 'recettes:feuille_modifier' ligne.pk %}" class="btn btn-sm btn-warning" title="Modifier"><i class="bi bi-pencil"></i></a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                            <p class="mt-2">Aucune ligne recette (feuille).</p>
                            {% if user.peut_saisir_demandes_recettes %}
                            <a href="{% url 'recettes:feuille_creer' %}" class="btn btn-primary btn-sm">Ajouter une ligne</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if page_obj.paginator.num_pages > 1 %}
<nav class="mt-2">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filtres.annee %}&annee={{ filtres.annee }}{% endif %}{% if filtres.mois %}&mois={{ filtres.mois }}{% endif %}{% if filtres.banque %}&banque={{ filtres.banque }}{% endif %}">Précédent</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
        {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filtres.annee %}&annee={{ filtres.annee }}{% endif %}{% if filtres.mois %}&mois={{ filtres.mois }}{% endif %}{% if filtres.banque %}&banque={{ filtres.banque }}{% endif %}">Suivant</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<div class="mt-2">
    <a href="{% url 'recettes:liste' %}" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Retour aux Recettes</a>
</div>
{% endblock %}
